<!-- Font Awesome Icons -->
<script src="https://kit.fontawesome.com/ac5381aca9.js" crossorigin="anonymous"></script>

<style>
    :root{
      --bg: #0b0f14;
      --card:#0f1720;
      --text:#e6edf3;
      --muted:#9fb0bf;
      --accent:#22c55e;
      --accent-2:#16a34a;
      --chip:#12202b;
      --chip-ring:#1f3b4c40;
      --border:#22303d;
    }

    html,body{height:100%;}
    body{
      font-family:'Poppins',sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* HERO / BACKDROP */
    .hero{
      position:relative;
      min-height:46vh;
      background:
        radial-gradient(1000px 400px at 10% 0%, #0b0f14 0%, #0b0f14d6 60%, #0b0f1400 100%),
        linear-gradient(0deg, #0b0f14 0%, #0b0f14d6 40%, #0b0f1400 70%),
        url('https://image.tmdb.org/t/p/original{{ movie.backdrop_url }}') center/cover no-repeat;
      border-bottom:1px solid var(--border);
    }
    .hero::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, #0b0f1400 0%, #0b0f14 85%);
    }

    /* Edge arrows */
    .arrow-btn{
      position:absolute; top:50%; transform:translateY(-50%);
      z-index:5; border:0; border-radius:999px; padding:.75rem;
      background:#00000066; color:white;
      backdrop-filter: blur(6px);
      transition: opacity 0.2s ease;
    }
    .arrow-btn:hover:not(:disabled){
      background:#00000088;
      cursor:pointer;
    }
    .arrow-btn:disabled{
      opacity:.25; 
      cursor:not-allowed;
      pointer-events: none;
      background:#00000033;
    }
    .arrow-left{ left: 12px; }
    .arrow-right{ right: 12px; }

    /* CONTENT CARD */
    .movie-card{
      position:relative; z-index:6; margin-top:-120px;
      background:var(--card); border:1px solid var(--border);
      border-radius:20px; box-shadow:0 10px 40px #00000066;
    }

    .poster{
      width:100%; max-width:340px; border-radius:14px; border:1px solid var(--border);
      box-shadow: 0 20px 40px #0009;
    }

    .title{
      font-weight:700; font-size:clamp(1.6rem, 2.2vw, 2.6rem); line-height:1.15; letter-spacing:-.02em;
    }
    .meta{
      color:var(--muted); font-weight:600; display:flex; gap:.75rem; flex-wrap:wrap;
    }
    .dot{opacity:.5;}

    /* Genre chips */
    .genre-chip{
      border:1px solid var(--border);
      background:var(--chip); color:var(--muted);
      border-radius:999px; padding:.35rem .7rem; font-size:.85rem; font-weight:600;
    }

    .plot{ color:#d7e1ea; line-height:1.65; }

    /* RATING CHIP (votes inside) */
    .rating-wrap{
      display:flex; flex-wrap:wrap; gap:1rem; align-items:center;
    }
    .rating-chip{
      display:flex; align-items:flex-start; gap:.6rem;
      background:var(--chip); border:1px solid var(--chip-ring);
      border-radius:14px; padding:.55rem .75rem; font-weight:700;
    }
    .rating-chip i{ font-size:1rem; color:#ffd166; line-height:1.2; margin-top:.1rem; }
    .rating-stack{ display:flex; flex-direction:column; line-height:1.1; }
    .rating-line{ display:flex; align-items:baseline; gap:.35rem; }
    .rating-number{ font-size:1.1rem; }
    .rating-outof{ color:var(--muted); font-weight:600; font-size:.95rem; }
    .rating-votes-mini{ color:var(--muted); font-weight:600; font-size:.85rem; }

    /* Trailer button */
    .trailer-btn{
      display:inline-flex; align-items:center; gap:.6rem;
      border-radius:12px; padding:.6rem .9rem; border:1px solid var(--border);
      background:#101a22; color:#e8f0f6; font-weight:600;
    }
    .trailer-btn i{ font-size:.95rem; }

    /* Cast scroller */
    .cast-strip{
      display:flex; gap:.75rem; overflow-x:auto; padding-bottom:.25rem;
      -webkit-overflow-scrolling:touch; scrollbar-width:thin;
    }
    .cast-strip::-webkit-scrollbar { height:6px; }
    .cast-strip::-webkit-scrollbar-thumb { background:#244154; border-radius:999px; }

    .actor-card{
      background:#0f1620; border:1px solid var(--border);
      width:135px; min-width:135px; border-radius:14px; overflow:hidden;
    }
    .actor-card img{ width:100%; height:180px; object-fit:cover; }
    .actor-card .actor-name, .actor-card .character{
      padding:.5rem .6rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:.85rem;
    }
    .actor-card .actor-name{ color:#dbe7f1; font-weight:600; }
    .actor-card .character{ color:var(--muted); border-top:1px solid var(--border); }

    .divider{ height:1px; background:var(--border); }

    /* Floating stats container */
    .stats-container{
      position: fixed;
      right: 2rem;
      top: 50%;
      transform: translateY(-50%);
      width: 280px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 10px 40px #00000066;
      z-index: 10;
    }

    .stats-container h3{
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: var(--text);
    }

    .stats-container .space-y-3 > * + *{
      margin-top: 0.75rem;
    }

    .stats-container .flex{
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .stats-container i{
      color: var(--muted);
      width: 16px;
      text-align: center;
    }

    @media (max-width: 1400px){
      .stats-container{
        display: none;
      }
    }

    @media (max-width: 992px){
      .movie-card{ margin-top:-80px; }
    }
  </style>
  <!-- HERO / BACKDROP -->
  <section class="hero relative">
    <!-- Prev -->
    <form method="POST" action="/previous_movie" id="prev-form" class="inline">
      <button type="submit" class="arrow-btn arrow-left" {% if previous_count == 0 %}disabled{% endif %} aria-label="Previous movie">
        <i class="fas fa-arrow-left"></i>
      </button>
    </form>
    <!-- Next -->
    <form method="POST" action="/next_movie" class="inline">
      <button type="submit" class="arrow-btn arrow-right" aria-label="Next movie">
        <i class="fas fa-arrow-right"></i>
      </button>
    </form>
  </section>

  <!-- CONTENT -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="movie-card p-4 md:p-8">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-4 lg:gap-8 items-start">

        <!-- Poster -->
        <div class="col-span-1 md:col-span-4 flex justify-center md:justify-start">
          <img class="poster" src="{{ movie.poster_url }}" alt="Poster for {{ movie.title }}">
        </div>

        <!-- Details -->
        <div class="col-span-1 md:col-span-8">
          <h1 class="title mb-2">{{ movie.title }} ({{ movie.year }})</h1>

          <div class="meta mb-3">
            <span>Directed by {{ movie.directors }}</span>
            {% if movie.age_rating and movie.age_rating != "Not Rated" %}
            <span class="dot">•</span>
            <span>{{ movie.age_rating }}</span>
            {% endif %}
          </div>

          <!-- Genres (built from CSV below) -->
          <div class="flex flex-wrap gap-2 mb-4" id="genre-info">{{ movie.genres }}</div>

          <!-- Plot -->
          <p class="plot mb-4">{{ movie.plot }}</p>

          <!-- Rating chip (with votes beneath /10) -->
          <div class="rating-wrap mb-4">
            <div class="rating-chip">
              <i class="fa-solid fa-star"></i>
              <div class="rating-stack">
                <div class="rating-line">
                  <span class="rating-number">{{ '%.1f'|format(movie.rating) }}</span>
                  <span class="rating-outof">/10</span>
                </div>
                <div class="rating-votes-mini"><span id="vote-number">{{ movie.votes }}</span> ratings</div>
              </div>
            </div>

            <button class="trailer-btn" id="play-button" data-video-url="{{ movie.trailer }}">
              <i class="fa-solid fa-play"></i>
              Play Trailer
            </button>
          </div>

          <!-- Divider + Prev/Next buttons -->
          <div class="divider my-4"></div>
          <div class="flex gap-2">
            <form method="POST" action="/previous_movie" id="prev-form-bottom" class="inline">
              <button type="submit" class="px-4 py-2 border border-white rounded-lg text-white hover:bg-white/10 disabled:opacity-25 disabled:cursor-not-allowed" {% if previous_count == 0 %}disabled{% endif %}>
                ← Previous
              </button>
            </form>
            <form method="POST" action="/next_movie" class="inline">
              <button type="submit" class="px-4 py-2 bg-white text-black rounded-lg hover:bg-gray-100">
                Next →
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Cast -->
      <div class="mt-8">
        <h2 class="text-lg font-bold mb-3">Cast</h2>
        <div class="cast-strip">
          {% for actor in movie.cast %}
          <div class="actor-card">
            {% if actor.image_url %}
              <img src="{{ actor.image_url }}" alt="{{ actor.name }}">
            {% else %}
              <div style="height:180px; display:flex; align-items:center; justify-content:center; color:var(--muted);">No image</div>
            {% endif %}
            <div class="actor-name">{{ actor.name }}</div>
            <div class="character">{{ actor.character }}</div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </main>

  <!-- Floating Movie Stats -->
  <div class="stats-container">
    <h3>Movie Details</h3>
    <div class="space-y-3">
      <!-- Runtime, Budget, Revenue, Language -->
      {% if movie.runtime and movie.runtime != "0 min" and movie.runtime != "Unknown" %}
      <div class="flex">
        <i class="fas fa-clock"></i>
        <span>{{ movie.runtime }}</span>
      </div>
      {% endif %}
      
      {% if movie.original_language and movie.original_language != "unknown" %}
      <div class="flex">
        <i class="fas fa-language"></i>
        <span>{{ movie.original_language.upper() }}</span>
      </div>
      {% endif %}
      
      {% if movie.budget and movie.budget != "Unknown" and movie.budget != "$0" %}
      <div class="flex">
        <i class="fas fa-dollar-sign"></i>
        <span>Budget: {{ movie.budget }}</span>
      </div>
      {% endif %}
      
      {% if movie.revenue and movie.revenue != "Unknown" and movie.revenue != "$0" %}
      <div class="flex">
        <i class="fas fa-chart-line"></i>
        <span>Revenue: {{ movie.revenue }}</span>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // Build up to 3 genre chips from CSV text already in #genre-info
    (function(){
      const el = document.getElementById("genre-info");
      if(!el) return;
      const raw = (el.textContent || "").trim();
      const parts = raw ? raw.split(",").map(s => s.trim()).filter(Boolean) : [];
      el.innerHTML = "";
      const max = 3;
      for(let i=0;i<Math.min(parts.length, max);i++){
        const chip = document.createElement("span");
        chip.className = "genre-chip";
        chip.textContent = parts[i];
        el.appendChild(chip);
      }
      if(parts.length > max){
        const more = document.createElement("span");
        more.className = "genre-chip";
        more.textContent = `+${parts.length - max} more`;
        el.appendChild(more);
      }
    })();

    // Format votes (e.g., 245000 -> 245K, 1_200_000 -> 1.2M)
    (function(){
      const voteElements = document.querySelectorAll("#vote-number, #vote-number-floating");
      voteElements.forEach(voteEl => {
        if(!voteEl) return;
        const num = parseInt(voteEl.textContent.replace(/[^0-9]/g,''), 10);
        if(isNaN(num)) return;
        let out = num.toString();
        if(num >= 1_000_000) out = (num/1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
        else if(num >= 1_000) out = (num/1_000).toFixed(1).replace(/\.0$/, "") + "K";
        voteEl.textContent = out;
      });
    })();

    // Trailer opener
    (function(){
      const btn = document.getElementById("play-button");
      if(!btn) return;
      btn.addEventListener("click", () => {
        const url = btn.getAttribute("data-video-url");
        if(url){ window.open(url, "_blank"); }
        else { alert("Trailer not available."); }
      });
    })();

    // Prevent form submission when previous button is disabled
    (function(){
      const prevForms = document.querySelectorAll('#prev-form, #prev-form-bottom');
      prevForms.forEach(form => {
        form.addEventListener('submit', (e) => {
          const btn = form.querySelector('button');
          if (btn && btn.disabled) {
            e.preventDefault();
            return false;
          }
        });
      });
      
      // Additional safety: remove href/action from disabled buttons
      const disabledBtns = document.querySelectorAll('button[disabled]');
      disabledBtns.forEach(btn => {
        btn.onclick = (e) => {
          e.preventDefault();
          return false;
        };
      });
    })();
  </script>
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Refine Filters – Nextreel</title>
  <meta name="description" content="Fine-tune your movie recommendations by score, votes, year, and genre." />
  <link rel="preconnect" href="https://image.tmdb.org" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Compiled Tailwind CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/output.css') }}">
  <script>
    (() => {
      try {
        const pref = localStorage.getItem('nr-theme');
        if (pref === 'light' || pref === 'dark') {
          document.documentElement.setAttribute('data-theme', pref);
        }
      } catch (e) {}
    })();
  </script>
  <style>
    :root { color-scheme: light; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif; }
    .font-brand-serif { font-family: 'Merriweather', Georgia, Cambria, 'Times New Roman', Times, serif; }
  </style>
</head>
<body class="bg-surface text-body antialiased">
  <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:rounded-md focus:bg-white focus:px-3 focus:py-2 focus:text-sm focus:shadow">Skip to content</a>

  <!-- Tailwind Navbar (kept consistent with home) -->
  <header class="sticky top-0 z-50 bg-primary/95 backdrop-blur supports-[backdrop-filter]:bg-primary/80 text-white shadow">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <a href="/" class="flex items-center gap-2 group" aria-label="Nextreel home">
          <svg class="h-6 w-6 transition-transform group-hover:rotate-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M4 6a2 2 0 0 1 2-2h8l6 6v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6z" opacity=".3"/>
            <path d="M14 4v4a2 2 0 0 0 2 2h4"/>
          </svg>
          <span class="font-brand-serif text-xl font-bold tracking-tight">Nextreel</span>
        </a>
        <nav class="hidden gap-2 md:flex">
          <a href="/next_movie" class="inline-flex items-center gap-2 rounded-xl bg-accent px-4 py-2 text-sm font-semibold text-white shadow hover:shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent/70 focus:ring-offset-primary/20">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            Pick a Movie
          </a>
          <a href="/setFilters" aria-current="page" class="inline-flex items-center gap-2 rounded-xl border border-accent px-4 py-2 text-sm font-semibold text-accent bg-white/0 hover:bg-accent/10 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent/70 focus:ring-offset-primary/20">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M3 5h18v2H3zm4 6h10v2H7zm3 6h4v2h-4z"/></svg>
            Set Filters
          </a>
        </nav>
        <button id="menuBtn" class="inline-flex items-center justify-center rounded-lg p-2 hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white md:hidden" aria-controls="mobileMenu" aria-expanded="false" aria-label="Open menu">
          <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
        </button>
      </div>
    </div>
    <div id="mobileMenu" class="hidden md:hidden border-t border-white/10">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-3 space-y-2">
        <a href="/next_movie" class="block w-full rounded-lg bg-accent px-4 py-2 text-sm font-semibold text-white text-center">Pick a Movie</a>
        <a href="/setFilters" class="block w-full rounded-lg border border-accent px-4 py-2 text-sm font-semibold text-accent text-center">Set Filters</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative isolate">
    <div class="absolute inset-0 -z-10 bg-gradient-to-br from-primary via-primary/90 to-slate-900"></div>
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex min-h-[40vh] items-center justify-center py-12 text-center">
        <div class="max-w-3xl text-white">
          <h1 class="font-brand-serif text-3xl sm:text-4xl font-extrabold tracking-tight">Customize Your Queue</h1>
          <p class="mt-3 text-sm/7 sm:text-base/7 opacity-90">Fine‑tune the movies you see by adjusting score, votes, release year and genres.</p>
          <div class="mt-6 flex items-center justify-center gap-3">
            <a href="#filters" class="inline-flex items-center gap-2 rounded-2xl bg-accent px-5 py-2.5 text-sm font-semibold text-white shadow hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-white">Jump to Filters</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filters Card -->
  <main id="main">
    <section id="filters" class="py-12 sm:py-16 bg-surface-alt">
      <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
        <form action="/filtered_movie" method="post" class="card border-t-4" style="border-top-color: var(--color-accent)" aria-describedby="filters-status">
          {% set has_filters = current_filters is defined and current_filters|length > 0 %}
          {% set current_filters_ui = current_filters_ui or {} %}
          {# Normalize defaults and detect unset bounds based on saved UI toggles #}
          {% set rating_min_default = 7.0 %}
          {% set rating_max_default = 10.0 %}
          {% set votes_min_default  = 100000 %}
          {% set votes_max_default  = 200000 %}
          {% set year_min_default   = 1900 %}
          {% set year_max_default   = 2025 %}
          {% set noScoreMin = current_filters_ui.get('score_no_min', False) %}
          {% set noScoreMax = current_filters_ui.get('score_no_max', False) %}
          {% set noVotesMin = current_filters_ui.get('votes_no_min', False) %}
          {% set noVotesMax = current_filters_ui.get('votes_no_max', False) %}
          {% set noYearMin  = current_filters_ui.get('year_no_min',  False) %}
          {% set noYearMax  = current_filters_ui.get('year_no_max',  False) %}
          <div id="filters-status" class="sr-only" role="status" aria-live="polite"></div>
          <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
            <!-- Left column -->
            <div class="space-y-8">
              <!-- Score Range -->
              <section aria-labelledby="score-heading" class="space-y-3">
                <h2 id="score-heading" class="flex items-center text-lg font-semibold text-primary">
                  <svg class="mr-2 h-5 w-5 text-accent" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                  IMDb Score Range
                </h2>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="imdb_score_min" class="block text-sm font-medium">Min Score</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="score_no_min" name="score_no_min" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noScoreMin %}checked{% endif %}>
                      No min
                    </label>
                  </div>
                  <input type="number" id="imdb_score_min" name="imdb_score_min" min="1" max="10" step="0.1" value="{{ (current_filters.get('min_rating', rating_min_default)) if not noScoreMin else '' }}" {% if noScoreMin %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="imdb_score_max" class="block text-sm font-medium">Max Score</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="score_no_max" name="score_no_max" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noScoreMax %}checked{% endif %}>
                      No max
                    </label>
                  </div>
                  <input type="number" id="imdb_score_max" name="imdb_score_max" min="1" max="10" step="0.1" value="{{ (current_filters.get('max_rating', rating_max_default)) if not noScoreMax else '' }}" {% if noScoreMax %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div class="mt-2">
                  <div class="flex items-center justify-between text-xs text-slate-600">
                    <span id="score_range_label" class="tabular-nums">Score: —</span>
                    <span class="tabular-nums">1 – 10</span>
                  </div>
                  <div class="mt-2 grid grid-cols-2 gap-2 items-center">
                    <input type="range" id="score_min_range" min="1" max="10" step="0.1" value="{{ current_filters.get('min_rating', rating_min_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('imdb_score_min');var t=document.getElementById('score_no_min');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var max=document.getElementById('score_max_range').value;var lab=document.getElementById('score_range_label');if(lab){lab.textContent='Score: '+parseFloat(el.value).toFixed(1)+' – '+parseFloat(max).toFixed(1);} })(this)">
                    <input type="range" id="score_max_range" min="1" max="10" step="0.1" value="{{ current_filters.get('max_rating', rating_max_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('imdb_score_max');var t=document.getElementById('score_no_max');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var min=document.getElementById('score_min_range').value;var lab=document.getElementById('score_range_label');if(lab){lab.textContent='Score: '+parseFloat(min).toFixed(1)+' – '+parseFloat(el.value).toFixed(1);} })(this)">
                  </div>
                </div>
              </section>

              <!-- Vote Range -->
              <section aria-labelledby="votes-heading" class="space-y-3">
                <h2 id="votes-heading" class="flex items-center text-lg font-semibold text-primary">
                  <svg class="mr-2 h-5 w-5 text-accent" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                  Vote Count Range
                </h2>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="num_votes_min" class="block text-sm font-medium">Min Votes</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="votes_no_min" name="votes_no_min" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noVotesMin %}checked{% endif %}>
                      No min
                    </label>
                  </div>
                  <input type="number" id="num_votes_min" name="num_votes_min" min="0" value="{{ (current_filters.get('min_votes', votes_min_default)) if not noVotesMin else '' }}" {% if noVotesMin %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="num_votes_max" class="block text-sm font-medium">Max Votes</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="votes_no_max" name="votes_no_max" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noVotesMax %}checked{% endif %}>
                      No max
                    </label>
                  </div>
                  <input type="number" id="num_votes_max" name="num_votes_max" min="1" max="2000000" value="{{ (current_filters.get('max_votes', votes_max_default)) if not noVotesMax else '' }}" {% if noVotesMax %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div class="mt-2">
                  <div class="flex items-center justify-between text-xs text-slate-600">
                    <span id="votes_range_label" class="tabular-nums">Votes: —</span>
                    <span class="tabular-nums">0 – 2,000,000</span>
                  </div>
                  <div class="mt-2 grid grid-cols-2 gap-2 items-center">
                    <input type="range" id="votes_min_range" min="0" max="2000000" step="10000" value="{{ current_filters.get('min_votes', votes_min_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('num_votes_min');var t=document.getElementById('votes_no_min');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var max=document.getElementById('votes_max_range').value;var lab=document.getElementById('votes_range_label');if(lab){var f=function(v){return v>=1000000?(v/1000000).toFixed(1).replace(/\\.0$/,'')+'M':v>=1000?Math.round(v/1000)+'k':String(v)};lab.textContent='Votes: '+f(parseInt(el.value,10))+' – '+f(parseInt(max,10));} })(this)">
                    <input type="range" id="votes_max_range" min="0" max="2000000" step="10000" value="{{ current_filters.get('max_votes', votes_max_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('num_votes_max');var t=document.getElementById('votes_no_max');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var min=document.getElementById('votes_min_range').value;var lab=document.getElementById('votes_range_label');if(lab){var f=function(v){return v>=1000000?(v/1000000).toFixed(1).replace(/\\.0$/,'')+'M':v>=1000?Math.round(v/1000)+'k':String(v)};lab.textContent='Votes: '+f(parseInt(min,10))+' – '+f(parseInt(el.value,10));} })(this)">
                  </div>
                </div>
              </section>
            </div>

            <!-- Right column -->
            <div class="space-y-8">
              <!-- Year Range -->
              <section aria-labelledby="year-heading" class="space-y-3">
                <h2 id="year-heading" class="flex items-center text-lg font-semibold text-primary">
                  <svg class="mr-2 h-5 w-5 text-accent" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 16H5V10h14v10z"/></svg>
                  Release Year Range
                </h2>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="year_min" class="block text-sm font-medium">Earliest</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="year_no_min" name="year_no_min" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noYearMin %}checked{% endif %}>
                      No min
                    </label>
                  </div>
                  <input type="number" id="year_min" name="year_min" min="1900" value="{{ (current_filters.get('min_year', year_min_default)) if not noYearMin else '' }}" {% if noYearMin %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div>
                  <div class="flex items-center justify-between">
                    <label for="year_max" class="block text-sm font-medium">Latest</label>
                    <label class="flex items-center gap-1 text-xs text-slate-600">
                      <input type="checkbox" id="year_no_max" name="year_no_max" class="h-3.5 w-3.5 rounded border-slate-300 text-accent focus:ring-accent" {% if noYearMax %}checked{% endif %}>
                      No max
                    </label>
                  </div>
                  <input type="number" id="year_max" name="year_max" value="{{ (current_filters.get('max_year', year_max_default)) if not noYearMax else '' }}" {% if noYearMax %}disabled{% endif %} class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30" placeholder="Any">
                </div>
                <div class="mt-2">
                  <div class="flex items-center justify-between text-xs text-slate-600">
                    <span id="year_range_label" class="tabular-nums">Year: —</span>
                    <span class="tabular-nums">1900 – 2025</span>
                  </div>
                  <div class="mt-2 grid grid-cols-2 gap-2 items-center">
                    <input type="range" id="year_min_range" min="1900" max="2025" step="1" value="{{ current_filters.get('min_year', year_min_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('year_min');var t=document.getElementById('year_no_min');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var max=document.getElementById('year_max_range').value;var lab=document.getElementById('year_range_label');if(lab){lab.textContent='Year: '+parseInt(el.value,10)+' – '+parseInt(max,10);} })(this)">
                    <input type="range" id="year_max_range" min="1900" max="2025" step="1" value="{{ current_filters.get('max_year', year_max_default) }}" class="w-full" oninput="(function(el){var n=document.getElementById('year_max');var t=document.getElementById('year_no_max');if(t&&t.checked){t.checked=false;n.removeAttribute('disabled');}n.value=el.value;var min=document.getElementById('year_min_range').value;var lab=document.getElementById('year_range_label');if(lab){lab.textContent='Year: '+parseInt(min,10)+' – '+parseInt(el.value,10);} })(this)">
                  </div>
                </div>
              </section>

              <!-- Language Selection -->
              <section aria-labelledby="language-heading" class="space-y-3">
                <h2 id="language-heading" class="flex items-center text-lg font-semibold text-primary">
                  <svg class="mr-2 h-5 w-5 text-accent" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>
                  </svg>
                  Language
                </h2>
                <div>
                  <label for="language" class="block text-sm font-medium">Select Language</label>
                  <select id="language" name="language" class="mt-1 w-full rounded-2xl border-2 border-slate-200 px-4 py-2.5 text-sm shadow-sm focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/30">
                    <option value="any" {% if current_filters.get('language', 'en') == 'any' %}selected{% endif %}>Any Language</option>
                    <option value="en" {% if current_filters.get('language', 'en') == 'en' %}selected{% endif %}>English</option>
                    <option value="es" {% if current_filters.get('language') == 'es' %}selected{% endif %}>Spanish</option>
                    <option value="fr" {% if current_filters.get('language') == 'fr' %}selected{% endif %}>French</option>
                    <option value="de" {% if current_filters.get('language') == 'de' %}selected{% endif %}>German</option>
                    <option value="it" {% if current_filters.get('language') == 'it' %}selected{% endif %}>Italian</option>
                    <option value="pt" {% if current_filters.get('language') == 'pt' %}selected{% endif %}>Portuguese</option>
                    <option value="ru" {% if current_filters.get('language') == 'ru' %}selected{% endif %}>Russian</option>
                    <option value="ja" {% if current_filters.get('language') == 'ja' %}selected{% endif %}>Japanese</option>
                    <option value="ko" {% if current_filters.get('language') == 'ko' %}selected{% endif %}>Korean</option>
                    <option value="zh" {% if current_filters.get('language') == 'zh' %}selected{% endif %}>Chinese</option>
                    <option value="hi" {% if current_filters.get('language') == 'hi' %}selected{% endif %}>Hindi</option>
                    <option value="ar" {% if current_filters.get('language') == 'ar' %}selected{% endif %}>Arabic</option>
                    <option value="tr" {% if current_filters.get('language') == 'tr' %}selected{% endif %}>Turkish</option>
                    <option value="nl" {% if current_filters.get('language') == 'nl' %}selected{% endif %}>Dutch</option>
                    <option value="sv" {% if current_filters.get('language') == 'sv' %}selected{% endif %}>Swedish</option>
                    <option value="pl" {% if current_filters.get('language') == 'pl' %}selected{% endif %}>Polish</option>
                  </select>
                </div>
              </section>

              <!-- Genres -->
              <section aria-labelledby="genres-heading" class="space-y-3">
                <h2 id="genres-heading" class="flex items-center text-lg font-semibold text-primary">
                  <svg class="mr-2 h-5 w-5 text-accent" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M20 2H8c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v10a2 2 0 0 0 2 2h12c1.1 0 2-.9 2-2v-2h2c1.1 0 2-.9 2-2V4a2 2 0 0 0-2-2zm-4 16H4V8h12v10zm4-4h-2V4h2v10z"/></svg>
                  Select Genres
                </h2>
                <div class="flex items-center gap-2 text-sm font-medium">
                  <input type="checkbox" id="selectAll" checked class="h-4 w-4 rounded border-slate-300 text-accent focus:ring-accent" />
                  <label for="selectAll">Select All</label>
                </div>
                <div class="genre-grid mt-2 flex flex-wrap gap-2">
                  {% set genres = ['Action','Adventure','Animation','Biography','Comedy','Crime','Documentary','Drama','Fantasy','Horror','Musical','Sci-Fi','Sport','Thriller','War','Western'] %}
                  {% for g in genres %}
                  <label class="relative">
                    {% set selected_genres = current_filters.get('genres', []) if has_filters else [] %}
                    <input type="checkbox" name="genres[]" value="{{ g }}" {% if selected_genres|length == 0 or g in selected_genres %}checked{% endif %} class="peer sr-only" />
                    <span class="inline-block select-none rounded-full border-2 border-slate-300 bg-slate-50 px-4 py-2 text-xs font-semibold text-slate-700 transition peer-checked:border-accent peer-checked:bg-accent peer-checked:text-white">{{ g }}</span>
                  </label>
                  {% endfor %}
                </div>
              </section>
            </div>
          </div>

          <!-- Active Filters Summary -->
          <div class="mt-6">
            <div class="text-sm font-semibold text-primary mb-2">Active Filters</div>
            <div id="activeFilters" class="flex flex-wrap gap-2"></div>
          </div>

          <!-- Buttons -->
          <div class="mt-10 flex items-center justify-center gap-3">
            <button type="reset" class="inline-flex items-center justify-center rounded-full bg-slate-200 px-6 py-2.5 text-sm font-semibold text-slate-700 hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-primary/30">Reset</button>
            <button id="applyBtn" type="submit" class="inline-flex items-center justify-center gap-2 rounded-full bg-accent px-7 py-3 text-sm font-bold uppercase tracking-wide text-white shadow shadow-black/10 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-accent/40" aria-busy="false">
              <svg class="h-4 w-4 hidden animate-spin motion-reduce:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10" opacity="0.25"/><path d="M12 2a10 10 0 0 1 10 10"/></svg>
              <span>Apply Filters</span>
            </button>
          </div>
          <script>
            (function(){
              var form = (function(){
                try {
                  var s = document.currentScript; if (!s) return null;
                  var prev = s.previousElementSibling; if (!prev) return null;
                  var found = prev.closest ? prev.closest('form') : null; if (found) return found;
                } catch (e) {}
                return document.querySelector('form[action="/filtered_movie"][method="post"]');
              })();
              const applyBtn = document.getElementById('applyBtn');
              const status = document.getElementById('filters-status');
              if (form && applyBtn && status) {
                form.addEventListener('submit', () => {
                  applyBtn.setAttribute('aria-busy', 'true');
                  status.textContent = 'Applying filters…';
                  const spinner = applyBtn.querySelector('svg');
                  if (spinner) spinner.classList.remove('hidden');
                  applyBtn.setAttribute('disabled', 'true');
                });
              }
            })();
          </script>
        </form>
      </div>
    </section>
  </main>

  <!-- Footer (simple) -->
  <footer class="border-t border-slate-200/60 bg-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-10">
      <div class="grid gap-8 md:grid-cols-3 md:items-start">
        <div>
          <a href="/" class="inline-flex items-center gap-2 text-primary">
            <svg class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 6a2 2 0 0 1 2-2h8l6 6v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6z" opacity=".3"/><path d="M14 4v4a2 2 0 0 0 2 2h4"/></svg>
            <span class="font-brand-serif text-lg font-bold">Nextreel</span>
          </a>
          <p class="mt-3 text-sm text-slate-600">&copy; 2025 Nextreel. All rights reserved.</p>
        </div>
        <div class="text-sm">
          <ul class="space-y-2">
            <li><a class="text-slate-600 hover:text-primary" href="#">About Us</a></li>
            <li><a class="text-slate-600 hover:text-primary" href="#">Privacy Policy</a></li>
            <li><a class="text-slate-600 hover:text-primary" href="#">DMCA</a></li>
          </ul>
        </div>
        <div class="text-sm">
          <h3 class="font-semibold text-slate-900">Contact</h3>
          <p class="mt-2 text-slate-600">Email: <a class="underline decoration-accent/50 underline-offset-4 hover:decoration-accent" href="mailto:bryce@nxtreel.com">bryce@nxtreel.com</a></p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Tiny JS: navbar toggle + Select All -->
  <script>
    // Navbar mobile toggle
    const menuBtn = document.getElementById('menuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    if (menuBtn && mobileMenu) {
      menuBtn.addEventListener('click', () => {
        const isOpen = mobileMenu.classList.toggle('hidden');
        const expanded = !isOpen;
        menuBtn.setAttribute('aria-expanded', String(expanded));
        menuBtn.setAttribute('aria-label', expanded ? 'Close menu' : 'Open menu');
      });
    }

    // Auto-apply disabled: use the Apply button to submit changes.

    // Select All genres
    const selectAllChk = document.getElementById('selectAll');
    const genreGrid   = document.querySelector('.genre-grid');
    const genreBoxes  = () => Array.from(genreGrid.querySelectorAll('input[type="checkbox"]'));

    function setAllGenres(checked) {
      genreBoxes().forEach(cb => cb.checked = checked);
    }
    function updateSelectAllState() {
      const boxes = genreBoxes();
      const allChecked = boxes.length > 0 && boxes.every(cb => cb.checked);
      selectAllChk.checked = allChecked;
    }

    if (selectAllChk && genreGrid) {
      selectAllChk.addEventListener('change', (e) => {
        setAllGenres(e.target.checked);
        updateSelectAllState();
      });
      genreGrid.addEventListener('change', () => {
        updateSelectAllState();
        renderActiveFilters();
      });
    }

    // No min/max toggles wiring
    function wireNoBound(toggleId, inputId, pairedRangeId) {
      const toggle = document.getElementById(toggleId);
      const input = document.getElementById(inputId);
      const pairedRange = pairedRangeId ? document.getElementById(pairedRangeId) : null;
      if (!toggle || !input) return;
      function applyState(trigger) {
        if (toggle.checked) {
          input.value = '';
          input.setAttribute('disabled', 'true');
        } else {
          input.removeAttribute('disabled');
        }
        renderActiveFilters();
      }
      toggle.addEventListener('change', () => applyState(false));
      // Apply initial state on load
      applyState(false);
    }

    wireNoBound('score_no_min', 'imdb_score_min', 'score_min_range');
    wireNoBound('score_no_max', 'imdb_score_max', 'score_max_range');
    wireNoBound('votes_no_min', 'num_votes_min', 'votes_min_range');
    wireNoBound('votes_no_max', 'num_votes_max', 'votes_max_range');
    wireNoBound('year_no_min', 'year_min', 'year_min_range');
    wireNoBound('year_no_max', 'year_max', 'year_max_range');

    // Dual-range slider wiring + sync with number inputs
    function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }
    function toNum(el) { const v = parseFloat(el.value); return isNaN(v) ? null : v; }
    function fmtScore(v) { return v.toFixed(1); }
    function fmtVotes(v) {
      if (v >= 1000000) return (v/1000000).toFixed(1).replace(/\.0$/,'') + 'M';
      if (v >= 1000) return (v/1000).toFixed(0) + 'k';
      return String(v);
    }
    function fmtYear(v) { return String(Math.round(v)); }

    function createRangePair({
      minRangeId, maxRangeId, minInputId, maxInputId,
      noMinToggleId, noMaxToggleId, min, max, step,
      labelId, labelPrefix, formatter
    }) {
      const rMin = document.getElementById(minRangeId);
      const rMax = document.getElementById(maxRangeId);
      const nMin = document.getElementById(minInputId);
      const nMax = document.getElementById(maxInputId);
      const tNoMin = document.getElementById(noMinToggleId);
      const tNoMax = document.getElementById(noMaxToggleId);
      const label = document.getElementById(labelId);
      if (!rMin || !rMax || !nMin || !nMax || !label) return;

      function updateLabel() {
        const noMin = tNoMin && tNoMin.checked;
        const noMax = tNoMax && tNoMax.checked;
        const lo = toNum(nMin);
        const hi = toNum(nMax);
        const loText = noMin || lo === null ? 'Any' : formatter(lo);
        const hiText = noMax || hi === null ? 'Any' : formatter(hi);
        label.textContent = `${labelPrefix}: ${loText} – ${hiText}`;
      }

      function syncRangesFromNumbers() {
        const nvMin = toNum(nMin);
        const nvMax = toNum(nMax);
        if (nvMin !== null) rMin.value = String(clamp(nvMin, min, max));
        if (nvMax !== null) rMax.value = String(clamp(nvMax, min, max));
        updateLabel();
      }

      function syncNumbersFromRanges() {
        const rvMin = parseFloat(rMin.value);
        const rvMax = parseFloat(rMax.value);
        // Ensure ordering
        if (rvMin > rvMax) {
          if (document.activeElement === rMin) {
            rMax.value = String(rvMin);
          } else {
            rMin.value = String(rvMax);
          }
        }
        // If user moves slider while 'No min/max' is set, re-enable that bound
        if (tNoMin && tNoMin.checked) { tNoMin.checked = false; nMin.removeAttribute('disabled'); }
        if (tNoMax && tNoMax.checked) { tNoMax.checked = false; nMax.removeAttribute('disabled'); }
        nMin.value = rMin.value;
        nMax.value = rMax.value;
        updateLabel();
      }

      // Wire events
      rMin.addEventListener('input', syncNumbersFromRanges);
      rMax.addEventListener('input', syncNumbersFromRanges);
      rMin.addEventListener('change', syncNumbersFromRanges);
      rMax.addEventListener('change', syncNumbersFromRanges);
      const onNumChange = () => { syncRangesFromNumbers(); };
      nMin.addEventListener('input', onNumChange);
      nMin.addEventListener('change', onNumChange);
      nMax.addEventListener('input', onNumChange);
      nMax.addEventListener('change', onNumChange);

      // Initial sync and label
      syncRangesFromNumbers();
      updateLabel();
    }

    // Create pairs
    createRangePair({
      minRangeId: 'score_min_range', maxRangeId: 'score_max_range',
      minInputId: 'imdb_score_min', maxInputId: 'imdb_score_max',
      noMinToggleId: 'score_no_min', noMaxToggleId: 'score_no_max',
      min: 1, max: 10, step: 0.1, labelId: 'score_range_label', labelPrefix: 'Score', formatter: fmtScore
    });
    createRangePair({
      minRangeId: 'votes_min_range', maxRangeId: 'votes_max_range',
      minInputId: 'num_votes_min', maxInputId: 'num_votes_max',
      noMinToggleId: 'votes_no_min', noMaxToggleId: 'votes_no_max',
      min: 0, max: 2000000, step: 10000, labelId: 'votes_range_label', labelPrefix: 'Votes', formatter: fmtVotes
    });
    createRangePair({
      minRangeId: 'year_min_range', maxRangeId: 'year_max_range',
      minInputId: 'year_min', maxInputId: 'year_max',
      noMinToggleId: 'year_no_min', noMaxToggleId: 'year_no_max',
      min: 1900, max: 2025, step: 1, labelId: 'year_range_label', labelPrefix: 'Year', formatter: fmtYear
    });

    // Active Filters chips
    function qs(id) { return document.getElementById(id); }
    const chipsEl = qs('activeFilters');
    function clearChips() { if (chipsEl) chipsEl.innerHTML = ''; }
    function addChip(text, onRemove) {
      if (!chipsEl) return;
      const chip = document.createElement('span');
      chip.className = 'inline-flex items-center gap-1 rounded-full bg-slate-200 text-slate-800 px-3 py-1 text-xs font-medium';
      chip.textContent = text;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'ml-1 rounded-full bg-slate-300/70 hover:bg-slate-400 px-1 text-[10px] leading-none';
      btn.setAttribute('aria-label', `Remove ${text}`);
      btn.textContent = '×';
      btn.addEventListener('click', () => { onRemove(); renderActiveFilters(); });
      chip.appendChild(btn);
      chipsEl.appendChild(chip);
    }

    function renderActiveFilters() {
      clearChips();
      // Score
      const scoreNoMin = (function(el){ return el ? !!el.checked : false; })(qs('score_no_min'));
      const scoreNoMax = (function(el){ return el ? !!el.checked : false; })(qs('score_no_max'));
      const sMin = toNum(qs('imdb_score_min'));
      const sMax = toNum(qs('imdb_score_max'));
      if (!scoreNoMin || !scoreNoMax) {
        var sMinVal = (sMin == null ? 1 : sMin);
        var sMaxVal = (sMax == null ? 10 : sMax);
        if (!scoreNoMin) addChip('Score ≥ ' + fmtScore(sMinVal), function(){ var el = qs('score_no_min'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
        if (!scoreNoMax) addChip('Score ≤ ' + fmtScore(sMaxVal), function(){ var el = qs('score_no_max'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
      }
      // Votes
      const votesNoMin = (function(el){ return el ? !!el.checked : false; })(qs('votes_no_min'));
      const votesNoMax = (function(el){ return el ? !!el.checked : false; })(qs('votes_no_max'));
      const vMin = toNum(qs('num_votes_min'));
      const vMax = toNum(qs('num_votes_max'));
      if (!votesNoMin || !votesNoMax) {
        var vMinVal = (vMin == null ? 0 : vMin);
        var vMaxVal = (vMax == null ? 2000000 : vMax);
        if (!votesNoMin) addChip('Votes ≥ ' + fmtVotes(vMinVal), function(){ var el = qs('votes_no_min'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
        if (!votesNoMax) addChip('Votes ≤ ' + fmtVotes(vMaxVal), function(){ var el = qs('votes_no_max'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
      }
      // Year
      const yearNoMin = (function(el){ return el ? !!el.checked : false; })(qs('year_no_min'));
      const yearNoMax = (function(el){ return el ? !!el.checked : false; })(qs('year_no_max'));
      const yMin = toNum(qs('year_min'));
      const yMax = toNum(qs('year_max'));
      if (!yearNoMin || !yearNoMax) {
        var yMinVal = (yMin == null ? 1900 : yMin);
        var yMaxVal = (yMax == null ? 2025 : yMax);
        if (!yearNoMin) addChip('Year ≥ ' + fmtYear(yMinVal), function(){ var el = qs('year_no_min'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
        if (!yearNoMax) addChip('Year ≤ ' + fmtYear(yMaxVal), function(){ var el = qs('year_no_max'); if (el) { el.checked = true; el.dispatchEvent(new Event('change')); }});
      }
      // Language
      const langSel = document.getElementById('language');
      if (langSel && langSel.value && langSel.value !== 'any') {
        var label = (langSel.options && langSel.options[langSel.selectedIndex] && langSel.options[langSel.selectedIndex].text) ? langSel.options[langSel.selectedIndex].text : langSel.value;
        addChip('Language: ' + label, function(){ langSel.value = 'any'; langSel.dispatchEvent(new Event('change')); });
      }
      // Genres
      document.querySelectorAll('.genre-grid input[type="checkbox"]').forEach(cb => {
        if (cb.checked) {
          addChip(cb.value, () => { cb.checked = false; cb.dispatchEvent(new Event('change', { bubbles: true })); });
        }
      });
    }

    // Wire language change
    const languageSelect = document.getElementById('language');
    if (languageSelect) {
      languageSelect.addEventListener('change', () => { renderActiveFilters(); });
    }

    // Handle Reset button to refresh states
    const formEl = document.querySelector('form[action="/filtered_movie"][method="post"]');
    if (formEl) {
      formEl.addEventListener('reset', () => {
        setTimeout(() => {
          // Trigger change on toggles to re-apply disabled states
          ['score_no_min','score_no_max','votes_no_min','votes_no_max','year_no_min','year_no_max'].forEach(id => {
            const el = document.getElementById(id); if (el) el.dispatchEvent(new Event('change'));
          });
          renderActiveFilters();
        }, 0);
      }, false);
    }

    // Initial render
    renderActiveFilters();
  </script>
</body>
</html>
